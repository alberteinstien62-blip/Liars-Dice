name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
          target: wasm32-unknown-unknown
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-clippy-
      - run: cargo clippy --all-targets -- -D warnings

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-test-
      - run: cargo test --all

  wasm-build:
    name: WASM Build
    runs-on: ubuntu-latest
    needs: [clippy, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-wasm-
      - run: cargo build --release --target wasm32-unknown-unknown
      - uses: actions/upload-artifact@v4
        with:
          name: wasm-contracts
          path: target/wasm32-unknown-unknown/release/*.wasm
          retention-days: 7

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: wasm-build
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t liars-dice:ci .

  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate HTML files
        run: |
          for f in frontend/web_a/index.html frontend/web_b/index.html frontend/index.html; do
            if [ -f "$f" ]; then
              echo "Checking $f..."
              python3 -c "
          import html.parser, sys
          class V(html.parser.HTMLParser):
              def __init__(self):
                  super().__init__()
                  self.errors = []
              def handle_starttag(self, tag, attrs): pass
              def handle_endtag(self, tag): pass
          v = V()
          with open('$f') as fh:
              try:
                  v.feed(fh.read())
                  print('  OK')
              except Exception as e:
                  print(f'  ERROR: {e}', file=sys.stderr)
                  sys.exit(1)
          "
            fi
          done
      - name: Check for localhost in production configs
        run: |
          if grep -r "localhost" frontend/*/config.json 2>/dev/null; then
            echo "::warning::config.json contains localhost references"
          fi
